<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ðŸŒ± Sistem Irigasi Tetes</title>

  <!-- CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
     :root {
      --bg:#f3f6f7;
      --card:#e3e5e6;          /* PATCH: warna card diubah jadi abu terang */
      --muted:#6a7073;
      --accent:#2ecc71;
      --accent-2:#ffb86b;
      --danger:#ff6b6b;
      --text:#111;
      --card-border:#c9cdcf;   /* border abu */
    }

    :root[data-theme="dark"] {
      --bg:#060607;
      --card:#2b2c2e;          /* PATCH: card dark â†’ abu gelap */
      --muted:#9aa6a9;
      --text:#e6f6ea;
      --card-border:#45484a;   /* border dark mode */
    }

    * {box-sizing:border-box; transition: all 0.35s ease-in-out;}

    body {
      margin:0;
      font-family:Inter,"Poppins",system-ui,Arial;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    .page {
      max-width:1200px;
      margin:0 auto;
      padding:16px;
    }

    header {
      text-align:center;
      margin-bottom:12px;
      position:relative;
    }

    .title {
      font-weight:700;
      color:var(--text);
      font-size:22px;
    }


    /* === THEME TOGGLE BUTTON === */
    #themeToggle {
      position:absolute;
      top:10px;
      right:10px;
      background:var(--card);
      color:var(--muted);
      border:1px solid var(--card-border);
      border-radius:50%;
      width:25px;
      height:25px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* GRID */
    .grid {
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:16px;
    }

    /* === CARD KECIL === */
    .small-card {
      background:var(--card);
      border:1.6px solid var(--card-border); /* PATCH border */
      border-radius:14px;
      padding:14px;
      text-align:center;
      color:var(--text);
    }
    .small-card .label {color:var(--muted); font-size:13px; margin-bottom:6px;}
    .small-card .value {font-weight:800; font-size:18px;}

    /* === SOIL GRID === */
    .soil-grid {
      grid-column:1 / span 2;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }

    /* === SOIL CARD === */
    .soil-card {
      background:var(--card);
      border:1.6px solid var(--card-border); /* PATCH */
      border-radius:16px;
      padding:16px;
      text-align:center;
      color:var(--text);
    }
    .soil-card h4 {margin:0 0 10px 0; color:var(--muted);}

    canvas {
      width:100%!important;
      height:auto!important;
      max-width:320px;
      display:block;
      margin:0 auto;
    }

    /* === AVG CARD === */
    .avg-card {
      grid-column:3 / span 2;
      background:var(--card);
      border:1.6px solid var(--card-border); /* PATCH */
      border-radius:16px;
      padding:20px;
      text-align:center;
      min-height:300px;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .avg-card h3 {
      margin-bottom:12px;
      font-weight:700;
      color:var(--muted);
    }

    /* === BUTTON CONTROL === */
    .controls {
      grid-column:1 / -1;
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:14px;
    }

    .btn {
      padding:10px 16px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-weight:700;
      color:#fff;
    }

    .pump-on{background:var(--accent);}
    .pump-off{background:#5b5c5d;}
    .mode-auto{background:#ef7d1a;}
    .mode-manual{background:#1976d2;}
    .logout{background:#6b7280;}
    .btn:disabled{opacity:0.5;}



    footer {margin-top:20px; text-align:center; color:#888; font-size:13px;}

    /* LOGIN */
    #login-box {
      display:none;
      position:fixed;
      inset:0;
      z-index:20;
      background:linear-gradient(180deg,#0f0f10,#161616);
      color:#e9f5ec;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #login-box .form {
      background:#1b1b1d;
      padding:28px 24px;
      border-radius:14px;
      width:90%;
      max-width:360px;
      text-align:center;
    }
    #login-box input {
      width:100%;
      padding:10px;
      margin-bottom:10px;
      border-radius:8px;
      border:none;
      background:#2a2a2d;
      color:#fff;
    }
    #login-box input:focus {outline:none; background:#333;}
    #login-box button {
      width:100%;
      padding:10px;
      border:none;
      border-radius:8px;
      background:#2ecc71;
      color:#fff;
      font-weight:700;
    }
    #login-box button:hover {background:#34d982;}
    .error{color:#ff6b6b;font-size:13px;}

    /* RESPONSIVE UNTUK TABLET */
    @media(max-width:920px){
      .grid{grid-template-columns:repeat(2,1fr);}
      .avg-card{grid-column:1 / -1;}
    }

    /* RESPONSIVE UNTUK HP */
	@media (max-width:480px){
		
	/* ATUR URUTAN ELEMEN DI DALAM GRID */
	.grid > .small-card:nth-child(1){order:1;} /* Suhu */
	.grid > .small-card:nth-child(2){order:2;} /* Kelembapan */
	.grid > .small-card:nth-child(3){order:3;} /* Pompa */
	.grid > .small-card:nth-child(4){order:4;} /* Mode */

	.grid > .soil-grid{order:5;}  /* Grup Soil 1â€“4 */
	.grid > .avg-card{order:6;}   /* Rata-rata Soil â†’ DI BAWAH Soil-grid */

	.grid > .controls{order:7;}   /* Tombol */

  	body{font-size:15px; overflow-y:auto;}
  	.page{padding:12px;}
  	.grid{display:flex; flex-direction:column; align-items:center; gap:12px;}
  	.small-card{width:90%; max-width:360px;}
  	.soil-grid{display:flex; flex-direction:column; align-items:center; gap:12px; width:100%;}
  	.soil-card{width:90%; max-width:360px;}

  	.avg-card{
    	width:90%; max-width:360px; min-height:240px;
    	display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    	padding-top:10px; position:relative;
  	}
  	.avg-card h3{
    	display:block; text-align:center; font-size:1rem; font-weight:600;
    	color:var(--muted); margin-bottom:10px; z-index:10;
  	}
  	.avg-card canvas{max-width:220px; width:90%; margin-top:8px;}

  	.controls{flex-direction:column; align-items:center; width:100%; margin-top:20px;}
  	.controls .btn{width:90%; max-width:320px;}
  	footer{text-align:center; margin-top:25px; font-size:14px;}
  	header .title{font-size:0.9rem; padding:8px 12px;}
	}
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-box">
  <div class="form">
   <h2><i class="fa-solid fa-lock"></i> Masuk Ke Sistem Irigasi Tetes</h2>
	<input type="email" id="email" placeholder="Email">
	<input type="password" id="password" placeholder="Kata sandi">
	<button id="btnLogin">Masuk</button>
	<p class="error" id="error"></p>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="page" style="display:none;">
  <header>
    <div class="title">ðŸŒ± SISTEM IRIGASI TETES ðŸ’§</div>
    <button id="themeToggle"><i class="fa-solid fa-moon"></i></button>
  </header>

  <section class="grid">
    <div class="small-card"><div class="label">Suhu</div><div id="suhu" class="value">-- Â°C</div></div>
    <div class="small-card"><div class="label">Kelembapan</div><div id="kelembapan" class="value">-- %</div></div>
    <div class="small-card"><div class="label">Pompa</div><div id="pumpStatus" class="value">--</div></div>
    <div class="small-card"><div class="label">Mode</div><div id="modeStatus" class="value">--</div></div>

    <div class="soil-grid">
      <div class="soil-card"><h4>Soil 1</h4><canvas id="soil1"></canvas></div>
      <div class="soil-card"><h4>Soil 2</h4><canvas id="soil2"></canvas></div>
      <div class="soil-card"><h4>Soil 3</h4><canvas id="soil3"></canvas></div>
      <div class="soil-card"><h4>Soil 4</h4><canvas id="soil4"></canvas></div>
    </div>

    <div class="avg-card">
      <h3>Rata-rata Soil</h3><canvas id="avgSoil"></canvas>
    </div>

    <div class="controls">
      <button id="btnPump" class="btn pump-off" disabled><i class="fa-solid fa-faucet"></i> Pompa: OFF</button>
      <button id="btnMode" class="btn mode-auto"><i class="fa-solid fa-gear"></i> Mode: AUTO</button>
      <button id="btnLogout" class="btn logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>
  </section>

  <footer>Â© 2025 Sistem Irigasi Tetes | by Muchtar Umar</footer>
</div>

<script>

/* === Tema Otomatis + Manual === */
const root=document.documentElement;
const themeBtn=document.getElementById('themeToggle');
function setTheme(mode){
  root.dataset.theme=mode;
  themeBtn.innerHTML=mode==='dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
  localStorage.setItem('theme',mode);
}
function autoTheme(){
  const h=new Date().getHours();
  const mode=(h>=6 && h<18)?'light':'dark';
  setTheme(mode);
}
const savedTheme=localStorage.getItem('theme');
if(savedTheme){setTheme(savedTheme);}else{autoTheme();}
themeBtn.onclick = () => {
  setTheme(root.dataset.theme === 'dark' ? 'light' : 'dark');

  // refresh semua gauge supaya warna teks berubah
  Object.values(charts).forEach(ch => ch.update());
};

/* === Firebase === */
const firebaseConfig = {
  apiKey: "AIzaSyDXjy1Pp7aJRLE6lEHK7p9Fl9VQamn58Q8",
  authDomain: "test-2ed59.firebaseapp.com",
  databaseURL: "https://test-2ed59-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "test-2ed59",
  storageBucket: "test-2ed59.firebasestorage.app",
  messagingSenderId: "792891724848",
  appId: "1:792891724848:web:a0fe758d7440285b5b49f5"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.database();

/* === Elemen === */
const loginBox=document.getElementById('login-box'),
      dashboard=document.getElementById('dashboard'),
      emailEl=document.getElementById('email'),
      passEl=document.getElementById('password'),
      btnLogin=document.getElementById('btnLogin'),
      errEl=document.getElementById('error'),
      btnLogout=document.getElementById('btnLogout'),
      suhuEl=document.getElementById('suhu'),
      kelembapanEl=document.getElementById('kelembapan'),
      pumpStatusEl=document.getElementById('pumpStatus'),
      modeStatusEl=document.getElementById('modeStatus'),
      btnPump=document.getElementById('btnPump'),
      btnMode=document.getElementById('btnMode');

/* === Chart.js Plugin === */
const centerTextPlugin = {
  id: 'centerText',
  afterDraw(chart) {
    const { ctx, chartArea: { width, height } } = chart;
    const v = chart.data.datasets[0].data[0];

    // warna otomatis berdasarkan theme
    const color = (root.dataset.theme === 'light') ? '#111' : '#dff6e6';

    ctx.save();
    ctx.font = `600 ${height / 10}px Inter`;
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${v}%`, width / 2, height / 2);
    ctx.restore();
  }
};

const edgeLabelPlugin = {
  id: 'edgeLabel',
  afterDraw(chart) {
    const { ctx, chartArea: { width, height } } = chart;
    const x = width / 2,
          y = height / 2;
    const r = chart._metasets[0].data[0].outerRadius;

    // warna otomatis mode terang/gelap
    const color = (root.dataset.theme === 'light') ? '#111' : '#aab3b6';

    ctx.save();
    ctx.fillStyle = color;
    ctx.font = 'bold 12px Inter';

    const a1 = (chart.options.rotation - 90) * Math.PI / 180;
    const a2 = (chart.options.rotation + chart.options.circumference - 90) * Math.PI / 180;

    ctx.fillText('0',   x + Math.cos(a1) * (r + 25), y + Math.sin(a1) * (r + 25));
    ctx.fillText('100', x + Math.cos(a2) * (r + 25), y + Math.sin(a2) * (r + 25));
    ctx.restore();
  }
};

/* === Gauge Setup === */
function getColor(v){return v>70?'#2ecc71':v>40?'#ffb86b':'#ff6b6b';}
function createGauge(id,val=0,opt={}){
  const ctx=document.getElementById(id).getContext('2d');
  return new Chart(ctx,{
    type:'doughnut',
    data:{datasets:[{data:[val,100-val],backgroundColor:[getColor(val),'#222'],borderWidth:0,borderRadius:50}]},
    options:{cutout:opt.cutout||'85%',rotation:opt.rotation??-135,circumference:opt.circumference??270,plugins:{legend:{display:false}}},
    plugins:[centerTextPlugin,edgeLabelPlugin]
  });
}
const charts={
  soil1:createGauge('soil1'),
  soil2:createGauge('soil2'),
  soil3:createGauge('soil3'),
  soil4:createGauge('soil4'),
  avg:createGauge('avgSoil',0,{rotation:-90,circumference:360})
};
function updateGauge(ch,v){
  v=Math.max(0,Math.min(100,v));
  ch.data.datasets[0].data=[v,100-v];
  ch.data.datasets[0].backgroundColor[0]=getColor(v);
  ch.update();
}

/* === Realtime Firebase === */
function startRealtime() {
  db.ref('SensorData').on('value', snap => {
    const d = snap.val();
    if (!d) return;

    // Ambil data suhu & kelembapan dari Firebase (field baru)
    suhuEl.textContent = `${d.temperature || '--'} Â°C`;
    kelembapanEl.textContent = `${d.humidity || '--'} %`;

    // Ambil data soil
    const s1 = +d.soil1 || 0,
          s2 = +d.soil2 || 0,
          s3 = +d.soil3 || 0,
          s4 = +d.soil4 || 0;
    const avg = Math.round((s1 + s2 + s3 + s4) / 4);

    // Update gauge
    updateGauge(charts.soil1, s1);
    updateGauge(charts.soil2, s2);
    updateGauge(charts.soil3, s3);
    updateGauge(charts.soil4, s4);
    updateGauge(charts.avg, avg);

    // Status pompa & mode
    const pump = (d.pump === 1 ? 'ON' : 'OFF');
    const mode = (d.mode || 'AUTO').toUpperCase();

    pumpStatusEl.textContent = pump;
    modeStatusEl.textContent = mode;

    // Tombol status
    btnPump.innerHTML = `<i class="fa-solid fa-faucet"></i> Pompa: ${pump}`;
    btnMode.innerHTML = `<i class="fa-solid fa-gear"></i> Mode: ${mode}`;
    btnPump.className = 'btn ' + (pump === 'ON' ? 'pump-on' : 'pump-off');
    btnMode.className = 'btn ' + (mode === 'AUTO' ? 'mode-auto' : 'mode-manual');
    btnPump.disabled = (mode === 'AUTO');
  });
}


/* === Kontrol Pompa & Mode === */
btnPump.onclick=()=>{
  if(btnPump.disabled)return;
  const newState=pumpStatusEl.textContent==='ON'?0:1;
  db.ref('SensorData/pump').set(newState);
};
btnMode.onclick=()=>{
  const newMode=modeStatusEl.textContent==='AUTO'?'MANUAL':'AUTO';
  db.ref('SensorData/mode').set(newMode);
};


/* === Login / Logout === */
btnLogin.onclick=()=>{
  const e=emailEl.value.trim(),p=passEl.value.trim();
  if(!e||!p){errEl.textContent='Isi email dan kata sandi';return;}
  auth.signInWithEmailAndPassword(e,p).catch(er=>errEl.textContent=er.message);
};
btnLogout.onclick=()=>auth.signOut();
auth.onAuthStateChanged(u=>{
  if(u){loginBox.style.display='none';dashboard.style.display='block';startRealtime();}
  else{loginBox.style.display='flex';dashboard.style.display='none';}
});
</script>
</body>
</html>





